<!DOCTYPE html>
<html>
<head>
<title>Card Management System</title>
<style>
body{
  background:#eef3f6;
  font-family:Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}

.loginBox, .box{
  background:white;
  padding:25px;
  border-radius:15px;
  width:450px;
  box-shadow:0 5px 20px rgba(0,0,0,.15);
  text-align:center;
}

.logo{
  width:240px;
  margin-bottom:10px;
}

input, select, button{
  width:100%;
  padding:10px;
  margin-top:10px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:15px;
}

button{
  background:#25acc0;
  color:white;
  border:none;
  cursor:pointer;
}

button:hover{opacity:.8}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  justify-content:center;
  align-items:center;
}

.modalBox{
  background:white;
  padding:20px;
  border-radius:10px;
  width:350px;
  text-align:left;
}

.statusDot{
  display:inline-block;
  width:12px;
  height:12px;
  border-radius:50%;
  margin-right:5px;
  vertical-align:middle;
}

.cardLabel{
  font-weight:bold;
  padding:2px 6px;
  border-radius:4px;
  color:white;
}

.card-Bronze{background:#cd7f32;}
.card-Silver{background:#c0c0c0; color:black;}
.card-Gold{background:#ffd700; color:black;}
</style>
</head>
<body>

<!-- Login -->
<div class="loginBox" id="loginBox">
  <h2>Admin Login</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<!-- Card Management -->
<div class="box" id="mainBox" style="display:none;">

  <img src="logo.png" class="logo">
  <h2>Al Rahma Discount Card System</h2>

  <input id="cardId" placeholder="Enter Card ID">
  <button onclick="checkCard()">Check Card</button>
  <hr>

  <h3>Add New Card</h3>
  <input id="name" placeholder="Name">
  <input id="phone" placeholder="Phone">

  <select id="category" onchange="autoDiscount()">
    <option value="">Select Category</option>
    <option value="Bronze">Bronze</option>
    <option value="Silver">Silver</option>
    <option value="Gold">Gold</option>
  </select>

  <input id="discount" placeholder="Discount %" readonly>
  <button onclick="addCard()">Add Card</button>

  <hr>
  <button onclick="cancelCard()">Cancel/Deactivate Card</button>

</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modalBox" id="modalBox"></div>
</div>

<script>

const API="https://script.google.com/macros/s/AKfycbzEuo4Psv8y1Qbq0cvkOMIRIWbGjKnkizF8XyO7fpDvB8mwoISrSnH5Pp13FSuJiDvI/exec"; // ضع هنا رابط Google Apps Script

// DOM Elements
const loginBox = document.getElementById("loginBox");
const mainBox = document.getElementById("mainBox");
const cardInput = document.getElementById("cardId");
const nameInput = document.getElementById("name");
const phoneInput = document.getElementById("phone");
const discountInput = document.getElementById("discount");
const categoryInput = document.getElementById("category");
const modal = document.getElementById("modal");
const modalBox = document.getElementById("modalBox");

// متغير عالمي لتخزين ID البطاقة بعد أي عملية
let currentCardId = "";

// Simple login credentials
const ADMIN_USER = "admin";
const ADMIN_PASS = "1234";

// Login
function login(){
  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  if(user === ADMIN_USER && pass === ADMIN_PASS){
    loginBox.style.display="none";
    mainBox.style.display="block";
  } else {
    alert("Invalid credentials");
  }
}

// Auto discount
function autoDiscount(){
  if(categoryInput.value=="Bronze") discountInput.value=20;
  if(categoryInput.value=="Silver") discountInput.value=25;
  if(categoryInput.value=="Gold") discountInput.value=30;
}

// JSONP helper
function jsonp(url, cb){
 let s=document.createElement("script");
 s.src=url+"&callback="+cb;
 document.body.appendChild(s);
}

// Show modal
function show(content){
  modal.style.display="flex";
  modalBox.innerHTML=content+"<br><br><button onclick='modal.style.display=\"none\"'>Close</button>";
}

// Check card
function checkCard(){
  if(!cardInput.value){ alert("Enter Card ID"); return; }
  currentCardId = cardInput.value; // خزّن ID الحالي
  jsonp(`${API}?action=check&id=${cardInput.value}`,"handleCheck");
}

function handleCheck(d){
  if(d=="NOT_FOUND"){
    show("Card Not Found");
    return;
  }

  const [id,name,phone,discount,category,grant,expiry,active,payment,invoice] = d;

  const grantDate = new Date(grant).toLocaleDateString();
  const expiryDate = new Date(expiry).toLocaleDateString();

  let statusColor="green", statusText="Card Is Active";
  if(active=="Card Is Deactivated"){ 
      statusColor="red"; 
      statusText="Canceled";
  } else if(new Date(expiry) < new Date()){ 
      statusColor="orange"; 
      statusText="Expired";
  } else {
      statusColor="green";
      statusText="Card Is Active";
  }

  show(`
    <div class="cardLabel card-${category}">${category}</div><br><br>
    <strong>ID:</strong> ${id}<br>
    <strong>Name:</strong> ${name}<br>
    <strong>Phone:</strong> ${phone}<br>
    <strong>Discount:</strong> ${discount}%<br>
    <strong>Grant:</strong> ${grantDate}<br>
    <strong>Expiry:</strong> ${expiryDate}<br>
    <strong>Payment:</strong> ${payment}<br>
    <strong>Invoice:</strong> ${invoice}<br>
    <span class="statusDot" style="background:${statusColor}"></span> ${statusText}
    ${statusText=="Expired"?`<br><button onclick="renewCard('${id}')">Renew Card</button>`:""}
  `);
}

// Add card
function addCard(){
  if(!nameInput.value || !phoneInput.value || !categoryInput.value){
    show("Please fill all fields");
    return;
  }

  const payment = prompt("Enter payment amount (required)");
  if(!payment){ alert("Payment is required"); return; }

  const invoice = prompt("Enter invoice/transaction number (required)");
  if(!invoice){ alert("Invoice number is required"); return; }

  jsonp(`${API}?action=add&name=${nameInput.value}&phone=${phoneInput.value}&discount=${discountInput.value}&category=${categoryInput.value}&payment=${payment}&invoice=${invoice}`,"handleAdd");
}

function handleAdd(d){
  if(d=="PHONE_EXISTS"){show("Phone already exists"); return;}
  if(d=="NAME_EXISTS"){show("Name already exists"); return;}
  if(d=="MISSING_PAYMENT"){show("Payment and Invoice required"); return;}
  show("Card Created: "+d);
}

// Cancel/deactivate card
function cancelCard(){
  let id = prompt("Enter Card ID to deactivate");
  if(!id) return;
  currentCardId = id; // خزّن ID
  jsonp(`${API}?action=cancel&id=${id}`, "handleCancel");
}

function handleCancel(d){
  if(d=="NOT_FOUND"){ show("Card Not Found"); return; }
  // تحديث popup بعد الإلغاء
  jsonp(`${API}?action=check&id=${currentCardId}`, "handleCheck");
}

// Renew card
function renewCard(id){
  const payment = prompt("Enter payment amount (required)");
  if(!payment){ alert("Payment is required"); return; }

  const invoice = prompt("Enter invoice/transaction number (required)");
  if(!invoice){ alert("Invoice number is required"); return; }

  currentCardId = id; // خزّن ID
  jsonp(`${API}?action=renew&id=${id}&payment=${payment}&invoice=${invoice}`, "handleRenew");
}

function handleRenew(d){
  if(d=="MISSING_PAYMENT"){show("Payment and Invoice required"); return;}
  if(d=="NOT_FOUND"){show("Card Not Found"); return;}
  // تحديث popup بعد التجديد
  jsonp(`${API}?action=check&id=${currentCardId}`, "handleCheck");
}

</script>
</body>
</html>



